// Generated by CoffeeScript 1.4.0
var Compound3DView;

Compound3DView = Backbone.View.extend({
  initialize: function(options) {
    this.model.on('change', this.render, this);
    return this.type = options.type;
  },
  events: function() {
    return {
      'click #BCK-Compound-3d-speckpresets input': 'selectPreset'
    };
  },
  render: function() {
    $(this.el).html(Handlebars.compile($(this.typeToTemplate[this.type]).html())({
      title: '3D View of ' + this.model.get('molecule_chembl_id')
    }));
    return this.getCoordsAndPaint();
  },
  showError: function() {
    return $(this.el).html(Handlebars.compile($('#Handlebars-Compound-3D-error').html())({
      msg: 'There was en error loading the data'
    }));
  },
  getCoordsAndPaint: function() {
    var e, f, getCoords, getXYZURL, getXZYcontent, molUrl, setXYZToModelAndPaint, standardInchi, standardInchiB64;
    $('#BCK-loadingcoords').show();
    standardInchi = this.model.get('molecule_structures')['standard_inchi'];
    standardInchiB64 = window.btoa(standardInchi);
    molUrl = Settings.BEAKER_BASE_URL + 'inchi2ctab/' + standardInchiB64;
    getXYZURL = function(data) {
      var url_and_data;
      url_and_data = {};
      url_and_data.url = Settings.BEAKER_BASE_URL + 'ctab2xyz';
      url_and_data.data = data;
      return url_and_data;
    };
    getXZYcontent = function(url_and_data) {
      var r;
      return r = $.ajax({
        type: "POST",
        url: url_and_data.url,
        data: url_and_data.data
      });
    };
    setXYZToModelAndPaint = function(xyzCoords) {
      $('#BCK-loadingcoords').hide();
      this.model.set('xyz', xyzCoords, {
        silent: true
      });
      return this.molVis = new MoleculeVisualisator("render-container", "renderer-canvas", this.model.get('xyz'));
    };
    f = $.proxy(setXYZToModelAndPaint, this);
    getCoords = $.ajax(molUrl).then(getXYZURL).then(getXZYcontent);
    getCoords.done(f);
    e = $.proxy(this.showError, this);
    return getCoords.fail(function() {
      return e();
    });
  },
  selectPreset: function(event) {
    var value;
    value = $(event.currentTarget).val();
    return this.molVis.changePreset(value);
  },
  typeToTemplate: {
    'reduced': '#Handlebars-Compound-3D-speck'
  }
});
