// Generated by CoffeeScript 1.4.0
var Compound3DView;

Compound3DView = Backbone.View.extend({
  initialize: function(options) {
    this.model.on('change', this.render, this);
    this.type = options.type;
    return this.getCoords();
  },
  events: function() {
    return {
      'click #BCK-Compound-3d-speckpresets input': 'selectPreset'
    };
  },
  render: function() {
    $(this.el).html(Handlebars.compile($(typeToTemplate[this.type]).html())({
      title: '3D View of ' + this.model.get('molecule_chembl_id')
    }));
    return this.molVis = new MoleculeVisualisator("render-container", "renderer-canvas", this.model.get('xyz'));
  },
  showError: function() {
    return $(this.el).html(Handlebars.compile($('#Handlebars-Compound-3D-error').html())({
      msg: 'There was en error loading the data'
    }));
  },
  getCoords: function() {
    var e, f, getCoords, getXYZURL, getXZYcontent, molUrl, setXYZToModel, standardInchi, standardInchiB64;
    standardInchi = this.model.get('molecule_structures')['standard_inchi'];
    standardInchiB64 = window.btoa(standardInchi);
    molUrl = 'https://www.ebi.ac.uk/chembl/api/utils/inchi2ctab/' + standardInchiB64;
    getXYZURL = function(data) {
      var ctabB64, xyzUrl;
      ctabB64 = window.btoa(data);
      xyzUrl = 'https://www.ebi.ac.uk/chembl/api/utils/ctab2xyz/' + ctabB64;
      return xyzUrl;
    };
    getXZYcontent = function(url) {
      return $.ajax(url);
    };
    setXYZToModel = function(xyzCoords) {
      return this.model.set('xyz', xyzCoords);
    };
    f = $.proxy(setXYZToModel, this);
    getCoords = $.ajax(molUrl).then(getXYZURL).then(getXZYcontent).then(f);
    e = $.proxy(this.showError, this);
    return getCoords.fail(function() {
      return e();
    });
  },
  selectPreset: function(event) {
    var value;
    value = $(event.currentTarget).val();
    return this.molVis.changePreset(value);
  },
  typeToTemplate: {
    'reduced': '#Handlebars-Compound-3D-speck'
  }
});
