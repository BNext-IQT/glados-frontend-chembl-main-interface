// Generated by CoffeeScript 1.4.0
var CompoundImageView;

CompoundImageView = CardView.extend({
  initialize: function() {
    return this.model.on('change', this.render, this);
  },
  render: function() {
    this.renderImage();
    this.initDownloadButtons();
    return this.initZoomModal();
  },
  renderImage: function() {
    var img, img_url;
    if (this.model.get('structure_type') === 'NONE') {
      img_url = '/static/img/structure_not_available.png';
    } else if (this.model.get('structure_type') === 'SEQ') {
      img_url = '/static/img/protein_structure.png';
    } else {
      img_url = 'https://www.ebi.ac.uk/chembl/api/data/image/' + this.model.get('molecule_chembl_id') + '.svg';
    }
    img = $(this.el).find('#Bck-COMP_IMG');
    img.load($.proxy(this.showVisibleContent, this));
    img.error(function() {
      return img.attr('src', '/static/img/structure_not_found.png');
    });
    img.attr('src', img_url);
    return $(this.el).find('#Bck-Renderer-Switch, #Bck-Format-Switch, #Bck-Coordinates-Switch').click(this.handleImgSwitch(this));
  },
  initDownloadButtons: function() {
    var img_url;
    img_url = 'https://www.ebi.ac.uk/chembl/api/data/image/' + this.model.get('molecule_chembl_id');
    $('.CNC-download-png').attr('href', img_url + '.png');
    $('.CNC-download-png').attr('download', this.model.get('molecule_chembl_id') + '.png');
    $('.CNC-download-svg').attr('href', img_url + '.svg');
    return $('.CNC-download-svg').attr('download', this.model.get('molecule_chembl_id') + '.svg');
  },
  initZoomModal: function() {
    var img, modal, title;
    modal = $(this.el).find('#CNC-zoom-modal');
    title = modal.find('h3');
    title.text(this.model.get('molecule_chembl_id'));
    img = modal.find('#Bck-Comp-Img-zoom');
    img.load(function() {
      $('#Bck-Comp-Img-zoom-preloader').hide();
      return $(this).show();
    });
    img.attr('src', 'https://www.ebi.ac.uk/chembl/api/data/image/' + this.model.get('molecule_chembl_id') + this.getParamsFromSwitches());
    return img.attr('alt', 'Structure of ' + this.model.get('molecule_chembl_id'));
  },
  handleImgSwitch: function(parentView) {
    return function() {
      var img;
      img = $(parentView.el).find('#Bck-Comp-Img-zoom');
      $('#Bck-Comp-Img-zoom-preloader').show();
      img.hide();
      return img.attr('src', 'https://www.ebi.ac.uk/chembl/api/data/image/' + parentView.model.get('molecule_chembl_id') + parentView.getParamsFromSwitches());
    };
  },
  getParamsFromSwitches: function() {
    var coords, format, renderer;
    renderer = 'engine=' + ($('#Bck-Renderer-Switch').prop('checked') ? 'indigo' : 'rdkit');
    format = 'format=' + ($('#Bck-Format-Switch').prop('checked') ? 'png' : 'svg');
    coords = $('#Bck-Coordinates-Switch').prop('checked') ? 'ignoreCoords=1' : '';
    return '?' + renderer + '&' + format + '&' + coords;
  }
});
