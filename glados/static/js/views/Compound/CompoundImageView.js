// Generated by CoffeeScript 1.4.0
var CompoundImageView;

CompoundImageView = CardView.extend(DownloadViewExt).extend({
  RENDERER_3D_SPECK_NAME: '3DSpeck',
  RENDERER_3D_LITEMOL_NAME: '3DLiteMol',
  initialize: function() {
    this.model.on('change', this.render, this);
    $(this.el).find("a[href='#BCK-compound-3dview-Speck']").attr('data-renderer', this.RENDERER_3D_SPECK_NAME);
    return $(this.el).find("a[href='#BCK-compound-3dview-LiteMol']").attr('data-renderer', this.RENDERER_3D_LITEMOL_NAME);
  },
  render: function() {
    this.renderImage();
    this.initDownloadButtons();
    return this.initZoomModal();
  },
  events: function() {
    return _.extend({}, DownloadViewExt.events, {
      "click #CNC-3d-modal-trigger": "initDefault3DView",
      "click #CNC-3d-modal-trigger-small": "initDefault3DView",
      "click a[href='#BCK-compound-3dview-Speck']": "lazyInit3DView",
      "click a[href='#BCK-compound-3dview-LiteMol']": "lazyInit3DView"
    });
  },
  renderImage: function() {
    var img, img_url;
    if (this.model.get('structure_type') === 'NONE') {
      img_url = '/static/img/structure_not_available.png';
    } else if (this.model.get('structure_type') === 'SEQ') {
      img_url = '/static/img/protein_structure.png';
    } else {
      img_url = Settings.WS_BASE_URL + 'image/' + this.model.get('molecule_chembl_id') + '.svg';
    }
    img = $(this.el).find('#Bck-COMP_IMG');
    img.load($.proxy(this.showCardContent, this));
    img.error(function() {
      return img.attr('src', '/static/img/structure_not_found.png');
    });
    return img.attr('src', img_url);
  },
  initDownloadButtons: function() {
    var img_url;
    img_url = Settings.WS_BASE_URL + 'image/' + this.model.get('molecule_chembl_id');
    $('.CNC-download-png').attr('href', img_url + '.png');
    $('.CNC-download-png').attr('download', this.model.get('molecule_chembl_id') + '.png');
    $('.CNC-download-svg').attr('href', img_url + '.svg');
    return $('.CNC-download-svg').attr('download', this.model.get('molecule_chembl_id') + '.svg');
  },
  initZoomModal: function() {
    var img, modal, title;
    img = $(this.el).find('#Bck-COMP_IMG');
    if (img.attr('src').indexOf('/static/') > -1) {
      $('#CNC-IMG-Options-Zoom, #CNC-IMG-Options-Zoom-small').remove();
      return;
    }
    modal = $(this.el).find('#CNC-zoom-modal');
    title = modal.find('h3');
    title.text(this.model.get('molecule_chembl_id'));
    img = modal.find('#Bck-Comp-Img-zoom');
    img.load(function() {
      $('#Bck-Comp-Img-zoom-preloader').hide();
      return $(this).show();
    });
    img.attr('src', Settings.WS_BASE_URL + 'image/' + this.model.get('molecule_chembl_id') + this.getParamsFromSwitches());
    img.attr('alt', 'Structure of ' + this.model.get('molecule_chembl_id'));
    $(this.el).find('#Bck-Renderer-Switch, #Bck-Format-Switch, #Bck-Coordinates-Switch').click(this.handleImgSwitch(this));
    $('#Bck-Comp-Img-zoom-menuclose').click(function() {
      return $('#Bck-Comp-Img-zoom-menu').slideUp(function() {
        return $('#Bck-Comp-Img-zoom-menuopen').show();
      });
    });
    return $('#Bck-Comp-Img-zoom-menuopen').click(function() {
      $('#Bck-Comp-Img-zoom-menu').slideDown();
      return $(this).hide();
    });
  },
  handleImgSwitch: function(parentView) {
    return function() {
      var img;
      img = $(parentView.el).find('#Bck-Comp-Img-zoom');
      $('#Bck-Comp-Img-zoom-preloader').show();
      img.hide();
      return img.attr('src', Settings.WS_BASE_URL + 'image/' + parentView.model.get('molecule_chembl_id') + parentView.getParamsFromSwitches());
    };
  },
  getParamsFromSwitches: function() {
    var coords, format, renderer;
    renderer = 'engine=' + ($('#Bck-Renderer-Switch').prop('checked') ? 'indigo' : 'rdkit');
    format = 'format=' + ($('#Bck-Format-Switch').prop('checked') ? 'png' : 'svg');
    coords = $('#Bck-Coordinates-Switch').prop('checked') ? 'ignoreCoords=1' : '';
    return '?' + renderer + '&' + format + '&' + coords;
  },
  initDefault3DView: function() {
    return $('ul.tabs').tabs('select_tab', 'BCK-compound-3dview-Speck');
  },
  lazyInit3DView: function(e) {
    var requiredRenderer, view;
    requiredRenderer = $(e.currentTarget).attr('data-renderer');
    view = this.get3DView(requiredRenderer);
    return view.render();
  },
  renderers3D: {},
  get3DView: function(rendererName) {
    if (!(this.renderers3D[rendererName] != null)) {
      switch (rendererName) {
        case this.RENDERER_3D_SPECK_NAME:
          this.renderers3D[rendererName] = new Compound3DViewSpeck({
            el: $('#BCK-compound-3dview-Speck'),
            model: this.model,
            type: 'reduced'
          });
          break;
        case this.RENDERER_3D_LITEMOL_NAME:
          this.renderers3D[rendererName] = new Compound3DViewLiteMol({
            el: $('#BCK-compound-3dview-LiteMol'),
            model: this.model
          });
      }
    }
    return this.renderers3D[rendererName];
  },
  getFilename: function(format) {
    if (format === 'csv') {
      return this.model.get('molecule_chembl_id') + 'NameAndClassification.csv';
    } else if (format === 'json') {
      return this.model.get('molecule_chembl_id') + 'NameAndClassification.json';
    } else if (format === 'xlsx') {
      return this.model.get('molecule_chembl_id') + 'NameAndClassification.xlsx';
    } else {
      return 'file.txt';
    }
  }
});
