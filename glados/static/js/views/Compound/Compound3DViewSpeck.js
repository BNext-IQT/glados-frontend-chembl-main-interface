// Generated by CoffeeScript 1.4.0
var Compound3DViewSpeck;

Compound3DViewSpeck = Backbone.View.extend({
  initialize: function(options) {
    this.model.on('change', this.render, this);
    this.type = options.type;
    return this.supportsWebGL = this.supportsWebGL();
  },
  events: function() {
    return {
      'click #BCK-Compound-3d-speckpresets input': 'selectPreset'
    };
  },
  render: function() {
    if (this.supportsWebGL) {
      $(this.el).html(Handlebars.compile($(this.typeToTemplate[this.type]).html())({
        title: '3D View of ' + this.model.get('molecule_chembl_id')
      }));
      if (!(this.model.get('xyz') != null)) {
        return this.getCoordsAndPaint();
      } else {
        this.molVis = new MoleculeVisualisator("render-container", "renderer-canvas", this.model.get('xyz'));
        return $('#BCK-loadingcoords').hide();
      }
    } else {
      return this.showError('WebGL does not seem to be available in this browser.');
    }
  },
  showError: function(msg) {
    return $(this.el).html(Handlebars.compile($('#Handlebars-Compound-3D-error').html())({
      msg: msg
    }));
  },
  getCoordsAndPaint: function() {
    var e, f, getCoords, getXYZURL, getXZYcontent, molUrl, setXYZToModelAndPaint, standardInchi, standardInchiB64;
    $('#BCK-loadingcoords').show();
    standardInchi = this.model.get('molecule_structures')['standard_inchi'];
    standardInchiB64 = window.btoa(standardInchi);
    molUrl = Settings.BEAKER_BASE_URL + 'inchi2ctab/' + standardInchiB64;
    getXYZURL = function(data) {
      var url_and_data;
      url_and_data = {};
      url_and_data.url = Settings.BEAKER_BASE_URL + 'ctab2xyz';
      url_and_data.data = data;
      return url_and_data;
    };
    getXZYcontent = function(url_and_data) {
      var r;
      return r = $.ajax({
        type: "POST",
        url: url_and_data.url,
        data: url_and_data.data
      });
    };
    setXYZToModelAndPaint = function(xyzCoords) {
      console.log('GOT COORDS!');
      $('#BCK-loadingcoords').hide();
      this.model.set('xyz', xyzCoords, {
        silent: true
      });
      return this.molVis = new MoleculeVisualisator("render-container", "renderer-canvas", this.model.get('xyz'));
    };
    f = $.proxy(setXYZToModelAndPaint, this);
    getCoords = $.ajax(molUrl).then(getXYZURL).then(getXZYcontent);
    getCoords.done(f);
    e = $.proxy(this.showError, this);
    return getCoords.fail(function() {
      return e('There was en error loading the data');
    });
  },
  selectPreset: function(event) {
    var value;
    value = $(event.currentTarget).val();
    return this.molVis.changePreset(value);
  },
  typeToTemplate: {
    'reduced': '#Handlebars-Compound-3D-speck'
  },
  supportsWebGL: function() {
    var canvas;
    try {
      canvas = document.createElement('canvas');
      return (window.WebGLRenderingContext != null) && (((canvas.getContext('webgl') != null) || canvas.getContext('experimental-webgl')) != null);
    } catch (e) {
      return false;
    }
  }
});
