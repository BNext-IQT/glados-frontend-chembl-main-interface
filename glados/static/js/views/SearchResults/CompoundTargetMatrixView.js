// Generated by CoffeeScript 1.4.0
var CompoundTargetMatrixView;

CompoundTargetMatrixView = Backbone.View.extend(ResponsiviseViewExt).extend({
  initialize: function() {
    var updateViewProxy;
    this.model.on('change', this.render, this);
    this.$vis_elem = $('#BCK-CompTargMatrixContainer');
    return updateViewProxy = this.setUpResponsiveRender();
  },
  render: function() {
    this.paintControls();
    this.paintMatrix();
    $(this.el).find('select').material_select();
    return $(this.el).find('.tooltipped').tooltip();
  },
  paintControls: function() {
    var config;
    config = this.model.get('config');
    this.paintSelect('.select-colouring-container', config.colour_properties, config.initial_colouring, 'select-colour-property', 'Colour by:');
    this.paintSelect('.select-row-sort-container', config.row_sorting_properties, config.initial_row_sorting, 'select-row-sort', 'Sort rows by:');
    this.paintSelect('.select-col-sort-container', config.col_sorting_properties, config.initial_col_sorting, 'select-col-sort', 'Sort columns by:');
    this.paintSortDirection('.btn-row-sort-direction-container', config.initial_row_sorting_reverse, 'row');
    return this.paintSortDirection('.btn-col-sort-direction-container', config.initial_col_sorting_reverse, 'col');
  },
  paintSortDirection: function(elemSelector, reverse, target_property) {
    var $sortDirectionBtn, $template;
    $sortDirectionBtn = $(this.el).find(elemSelector);
    $template = $('#' + $sortDirectionBtn.attr('data-hb-template'));
    if (reverse) {
      return $sortDirectionBtn.html(Handlebars.compile($template.html())({
        sort_class: 'fa fa-sort-desc',
        text: 'Desc',
        target_property: target_property
      }));
    } else {
      return $sortDirectionBtn.html(Handlebars.compile($template.html())({
        sort_class: 'fa fa-sort-asc',
        text: 'Asc',
        target_property: target_property
      }));
    }
  },
  paintSelect: function(elemSelector, propsList, defaultValue, customClass, label) {
    var $select, $template, columns;
    columns = _.map(propsList, function(item) {
      return {
        comparator: item,
        selected: item === defaultValue
      };
    });
    $select = $(this.el).find(elemSelector);
    $template = $('#' + $select.attr('data-hb-template'));
    return $select.html(Handlebars.compile($template.html())({
      custom_class: customClass,
      columns: columns,
      custom_label: label
    }));
  },
  paintMatrix: function() {
    var buildNumericColourScale, buildTextColourScale, columns, columnsIndex, config, currentColSortingProperty, currentColSortingPropertyReverse, currentColourProperty, currentRowSortingProperty, currentRowSortingPropertyReverse, defineColourScale, elemWidth, fillColour, fillLeyendDetails, fillRow, getCellColour, getCellTooltip, getColumnTooltip, getDomainForContinuousProperty, getDomainForOrdinalProperty, getRowTooltip, getXCoord, getYCoord, handleSortDirClick, handleZoom, height, initialColWidth, initialRowHeight, leyendHeight, leyendSVG, leyendWidth, links, mainContainer, margin, matrix, minColWidth, minRowHeight, numColumns, numRows, paintSortDirectionProxy, rangeXEnd, rangeYEnd, resetZoom, rows, rowsIndex, sortMatrixColsBy, sortMatrixRowsBy, svg, thisView, triggerColSortTransition, triggerRowSortTransition, width, zoom, _i, _j, _results, _results1;
    matrix = {
      "columns": [
        {
          "name": "C1",
          "originalIndex": 0,
          "currentPosition": 0,
          pchembl_value_sum: 30,
          published_value_sum: 330
        }, {
          "name": "C2",
          "originalIndex": 1,
          "currentPosition": 1,
          pchembl_value_sum: 26,
          published_value_sum: 260
        }, {
          "name": "C3",
          "originalIndex": 2,
          "currentPosition": 2,
          pchembl_value_sum: 22,
          published_value_sum: 190
        }
      ],
      "rows": [
        {
          "name": "T1",
          "originalIndex": 0,
          "currentPosition": 0,
          pchembl_value_sum: 33,
          published_value_sum: 240
        }, {
          "name": "T2",
          "originalIndex": 1,
          "currentPosition": 1,
          pchembl_value_sum: 24,
          published_value_sum: 210
        }, {
          "name": "T3",
          "originalIndex": 2,
          "currentPosition": 2,
          pchembl_value_sum: 15,
          published_value_sum: 90
        }, {
          "name": "T4",
          "originalIndex": 3,
          "currentPosition": 3,
          pchembl_value_sum: 6,
          published_value_sum: 240
        }
      ],
      "links": {
        0: {
          0: {
            'num_bioactivities': 0,
            'assay_type': 'U',
            'pchembl_value': 12,
            molecule_chembl_id: 'C1',
            target_chembl_id: 'T1',
            'published_value': 120
          },
          1: {
            'num_bioactivities': 10,
            'assay_type': 'P',
            'pchembl_value': 11,
            molecule_chembl_id: 'C2',
            target_chembl_id: 'T1',
            'published_value': 80
          },
          2: {
            'num_bioactivities': 0,
            'assay_type': 'B',
            'pchembl_value': 10,
            molecule_chembl_id: 'C3',
            target_chembl_id: 'T1',
            'published_value': 40
          }
        },
        1: {
          0: {
            'num_bioactivities': 0,
            'assay_type': 'A',
            'pchembl_value': 9,
            molecule_chembl_id: 'C1',
            target_chembl_id: 'T2',
            'published_value': 110
          },
          1: {
            'num_bioactivities': 20,
            'assay_type': 'T',
            'pchembl_value': 8,
            molecule_chembl_id: 'C2',
            target_chembl_id: 'T2',
            'published_value': 70
          },
          2: {
            'num_bioactivities': 0,
            'assay_type': 'F',
            'pchembl_value': 7,
            molecule_chembl_id: 'C3',
            target_chembl_id: 'T2',
            'published_value': 30
          }
        },
        2: {
          0: {
            'num_bioactivities': 0,
            'assay_type': 'U',
            'pchembl_value': 6,
            molecule_chembl_id: 'C1',
            target_chembl_id: 'T3',
            'published_value': 10
          },
          1: {
            'num_bioactivities': 30,
            'assay_type': 'P',
            'pchembl_value': 5,
            molecule_chembl_id: 'C2',
            target_chembl_id: 'T3',
            'published_value': 60
          },
          2: {
            'num_bioactivities': 0,
            'assay_type': 'B',
            'pchembl_value': 4,
            molecule_chembl_id: 'C3',
            target_chembl_id: 'T3',
            'published_value': 20
          }
        },
        3: {
          0: {
            'num_bioactivities': 0,
            'assay_type': 'A',
            'pchembl_value': 3,
            molecule_chembl_id: 'C1',
            target_chembl_id: 'T4',
            'published_value': 90
          },
          1: {
            'num_bioactivities': 40,
            'assay_type': 'T',
            'pchembl_value': 2,
            molecule_chembl_id: 'C2',
            target_chembl_id: 'T4',
            'published_value': 50
          },
          2: {
            'num_bioactivities': 0,
            'assay_type': 'F',
            'pchembl_value': 1,
            molecule_chembl_id: 'C3',
            target_chembl_id: 'T4',
            'published_value': 100
          }
        }
      }
    };
    matrix = this.model.get('matrix');
    config = this.model.get('config');
    currentColourProperty = config.initial_colouring;
    margin = {
      top: 150,
      right: 0,
      bottom: 10,
      left: 90
    };
    elemWidth = $(this.el).width();
    width = 0.8 * elemWidth;
    height = width;
    mainContainer = d3.select('#' + this.$vis_elem.attr('id'));
    leyendWidth = width / 2;
    leyendHeight = 100;
    leyendSVG = mainContainer.append('svg').attr('width', leyendWidth).attr('height', leyendHeight);
    svg = mainContainer.append('svg').attr('width', width + margin.left + margin.right).attr('height', height + margin.top + margin.bottom).append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    links = matrix.links;
    numColumns = matrix.columns.length;
    numRows = matrix.rows.length;
    rowsIndex = _.indexBy(matrix.rows, 'name');
    columnsIndex = _.indexBy(matrix.columns, 'name');
    sortMatrixRowsBy = function(prop, reverse) {
      var index, newOrders, row, _i, _len, _results;
      newOrders = _.sortBy(matrix.rows, prop);
      if (reverse) {
        newOrders = newOrders.reverse();
      }
      _results = [];
      for (index = _i = 0, _len = newOrders.length; _i < _len; index = ++_i) {
        row = newOrders[index];
        _results.push(rowsIndex[row.name].currentPosition = index);
      }
      return _results;
    };
    sortMatrixRowsBy(config.initial_row_sorting + '_sum', config.initial_row_sorting_reverse);
    sortMatrixColsBy = function(prop, reverse) {
      var index, newOrders, row, _i, _len, _results;
      newOrders = _.sortBy(matrix.columns, prop);
      if (reverse) {
        newOrders = newOrders.reverse();
      }
      _results = [];
      for (index = _i = 0, _len = newOrders.length; _i < _len; index = ++_i) {
        row = newOrders[index];
        _results.push(columnsIndex[row.name].currentPosition = index);
      }
      return _results;
    };
    sortMatrixColsBy(config.initial_col_sorting + '_sum', config.initial_col_sorting_reverse);
    svg.append("rect").attr("class", "background").style("fill", "white").attr("width", width).attr("height", height);
    currentRowSortingProperty = config.initial_row_sorting + '_sum';
    currentRowSortingPropertyReverse = config.initial_row_sorting_reverse;
    currentColSortingProperty = config.initial_col_sorting + '_sum';
    currentColSortingPropertyReverse = config.initial_row_sorting_reverse;
    getDomainForOrdinalProperty = function(prop) {
      var cell, colNum, domain, row, rowNum, value, _ref;
      domain = [];
      _ref = matrix.links;
      for (rowNum in _ref) {
        row = _ref[rowNum];
        for (colNum in row) {
          cell = row[colNum];
          value = cell[prop];
          if (value != null) {
            domain.push(value);
          }
        }
      }
      return domain;
    };
    getDomainForContinuousProperty = function(prop) {
      var cell, colNum, maxVal, minVal, row, rowNum, value, _ref;
      minVal = Number.MAX_VALUE;
      maxVal = Number.MIN_VALUE;
      _ref = matrix.links;
      for (rowNum in _ref) {
        row = _ref[rowNum];
        for (colNum in row) {
          cell = row[colNum];
          value = parseFloat(cell[prop]);
          if (value > maxVal) {
            maxVal = value;
          }
          if (value < minVal) {
            minVal = value;
          }
        }
      }
      return [minVal, maxVal];
    };
    minRowHeight = minColWidth = 30;
    initialRowHeight = height / numRows;
    if (initialRowHeight < minRowHeight) {
      rangeYEnd = minRowHeight * numRows;
    } else {
      rangeYEnd = height;
    }
    initialColWidth = width / numColumns;
    if (initialColWidth < minColWidth) {
      rangeXEnd = minColWidth * numColumns;
    } else {
      rangeXEnd = width;
    }
    getYCoord = d3.scale.ordinal().domain((function() {
      _results = [];
      for (var _i = 0; 0 <= numRows ? _i <= numRows : _i >= numRows; 0 <= numRows ? _i++ : _i--){ _results.push(_i); }
      return _results;
    }).apply(this)).rangeBands([0, rangeYEnd]);
    getXCoord = d3.scale.ordinal().domain((function() {
      _results1 = [];
      for (var _j = 0; 0 <= numColumns ? _j <= numColumns : _j >= numColumns; 0 <= numColumns ? _j++ : _j--){ _results1.push(_j); }
      return _results1;
    }).apply(this)).rangeBands([0, rangeXEnd]);
    buildNumericColourScale = function(currentProperty) {
      var colourDomain, scale;
      colourDomain = getDomainForContinuousProperty(currentProperty);
      scale = d3.scale.linear().domain(colourDomain).range(["#FFFFFF", Settings.EMBL_GREEN]);
      return scale;
    };
    buildTextColourScale = function(currentProperty) {
      var domain, scale;
      domain = getDomainForOrdinalProperty(currentProperty);
      scale = d3.scale.ordinal().domain(domain).range(d3.scale.category20().range());
      return scale;
    };
    defineColourScale = function(links, currentProperty) {
      var scale, type;
      type = config.propertyToType[currentProperty];
      scale = (function() {
        switch (false) {
          case type !== 'number':
            return buildNumericColourScale(currentProperty);
          case type !== 'string':
            return buildTextColourScale(currentProperty);
        }
      })();
      return scale;
    };
    getCellColour = defineColourScale(links, currentColourProperty);
    fillColour = function(d) {
      if (!(d[currentColourProperty] != null)) {
        return '#9e9e9e';
      }
      return getCellColour(d[currentColourProperty]);
    };
    fillLeyendDetails = function() {
      var colourDataType, data, domain, getXInLeyendFor, leyendAxis, leyendG, linearScalePadding, numValues, rectangleHeight, start, step, stepWidthInScale, stop;
      leyendSVG.selectAll('g').remove();
      leyendSVG.selectAll('text').remove();
      leyendG = leyendSVG.append('g').attr("transform", "translate(0," + (leyendHeight - 30) + ")");
      leyendSVG.append('text').text('Leyend for: ' + currentColourProperty).attr("transform", "translate(10, 15)");
      rectangleHeight = 50;
      colourDataType = config.propertyToType[currentColourProperty];
      if (colourDataType === 'string') {
        domain = getDomainForOrdinalProperty(currentColourProperty);
        getXInLeyendFor = d3.scale.ordinal().domain(domain).rangeBands([0, leyendWidth]);
        leyendAxis = d3.svg.axis().scale(getXInLeyendFor).orient("bottom");
        leyendG.selectAll('rect').data(getXInLeyendFor.domain()).enter().append('rect').attr('height', rectangleHeight).attr('width', getXInLeyendFor.rangeBand()).attr('x', function(d) {
          return getXInLeyendFor(d);
        }).attr('y', -rectangleHeight).attr('fill', function(d) {
          return getCellColour(d);
        });
        return leyendG.call(leyendAxis);
      } else if (colourDataType === 'number') {
        domain = getDomainForContinuousProperty(currentColourProperty);
        linearScalePadding = 10;
        getXInLeyendFor = d3.scale.linear().domain(domain).range([linearScalePadding, leyendWidth - linearScalePadding]);
        leyendAxis = d3.svg.axis().scale(getXInLeyendFor).orient("bottom");
        start = domain[0];
        stop = domain[1];
        numValues = 20;
        step = Math.abs(stop - start) / numValues;
        stepWidthInScale = Math.abs(getXInLeyendFor.range()[0] - getXInLeyendFor.range()[1]) / numValues;
        data = d3.range(domain[0], domain[1], step);
        leyendG.selectAll('rect').data(data).enter().append('rect').attr('height', rectangleHeight).attr('width', stepWidthInScale + 5).attr('x', function(d) {
          return getXInLeyendFor(d);
        }).attr('y', -rectangleHeight).attr('fill', function(d) {
          return getCellColour(d);
        });
        return leyendG.call(leyendAxis);
      }
    };
    fillLeyendDetails();
    getCellTooltip = function(d) {
      var txt;
      txt = "molecule: " + d.molecule_chembl_id + "\n" + "target: " + d.target_chembl_id + "\n" + currentColourProperty + ":" + d[currentColourProperty];
      return txt;
    };
    getRowTooltip = function(d) {
      var txt;
      txt = "target: " + d.name + "\n" + currentRowSortingProperty + ":" + d[currentRowSortingProperty];
      return txt;
    };
    fillRow = function(row, rowNumber) {
      var cells, col, columnsList, dataList, i, j, rowInMatrix, value, _k, _len;
      columnsList = matrix.columns;
      rowInMatrix = matrix.rows[rowNumber];
      i = rowInMatrix.originalIndex;
      dataList = [];
      for (_k = 0, _len = columnsList.length; _k < _len; _k++) {
        col = columnsList[_k];
        j = col.originalIndex;
        value = links[i][j];
        dataList.push(value);
      }
      cells = d3.select(this).selectAll(".vis-cell").data(dataList).enter().append("rect").attr("class", "vis-cell").attr("x", function(d, colNum) {
        return getXCoord(columnsList[colNum].currentPosition);
      }).attr("width", getXCoord.rangeBand()).attr("height", getYCoord.rangeBand()).style("fill", fillColour);
      return cells.classed('tooltipped', true).attr('data-position', 'bottom').attr('data-delay', '50').attr('data-tooltip', getCellTooltip);
    };
    rows = svg.selectAll('.vis-row').data(matrix.rows).enter().append('g').attr('class', 'vis-row').attr('transform', function(d) {
      return "translate(0, " + getYCoord(d.currentPosition) + ")";
    }).each(fillRow);
    rows.append("line").attr("x2", width);
    rows.append("text").attr("x", -6).attr("y", getYCoord.rangeBand() / 2).attr("dy", ".32em").attr("text-anchor", "end").attr('style', 'font-size:12px;').attr('text-decoration', 'underline').attr('cursor', 'pointer').attr('fill', '#1b5e20').text(function(d, i) {
      return d.name;
    }).classed('tooltipped', true).attr('data-position', 'bottom').attr('data-delay', '50').attr('data-tooltip', getRowTooltip);
    getColumnTooltip = function(d) {
      var txt;
      return txt = "molecule: " + d.name + "\n" + currentColSortingProperty + ":" + d[currentColSortingProperty];
    };
    columns = svg.selectAll(".vis-column").data(matrix.columns).enter().append("g").attr("class", "vis-column").attr("transform", function(d) {
      return "translate(" + getXCoord(d.currentPosition) + ")rotate(-90)";
    });
    columns.append("line").attr("x1", -width);
    columns.append("text").attr("x", 0).attr("y", getXCoord.rangeBand() / 2).attr("dy", ".32em").attr("text-anchor", "start").attr('style', 'font-size:12px;').attr('text-decoration', 'underline').attr('cursor', 'pointer').attr('fill', '#1b5e20').text(function(d, i) {
      return d.name;
    }).classed('tooltipped', true).attr('data-position', 'bottom').attr('data-delay', '50').attr('data-tooltip', getColumnTooltip);
    handleZoom = function() {
      getYCoord.rangeBands([0, rangeYEnd * zoom.scale()]);
      getXCoord.rangeBands([0, rangeXEnd * zoom.scale()]);
      svg.selectAll('.vis-row').attr('transform', function(d) {
        return "translate(" + zoom.translate()[0] + ", " + (getYCoord(d.currentPosition) + zoom.translate()[1]) + ")";
      }).selectAll("text").attr("y", getYCoord.rangeBand() / 2.);
      svg.selectAll(".vis-column").attr("transform", function(d) {
        return "translate(" + getXCoord(d.currentPosition) + ")rotate(-90)";
      }).selectAll("text").attr("y", getXCoord.rangeBand() / 2.).attr('transform', function(d) {
        return "translate( " + (-zoom.translate()[1]) + ", " + zoom.translate()[0] + ")";
      });
      return svg.selectAll(".vis-cell").attr("width", getXCoord.rangeBand()).attr("height", getYCoord.rangeBand()).attr("x", function(d, index) {
        return getXCoord(matrix.columns[index % matrix.columns.length].currentPosition);
      });
    };
    zoom = d3.behavior.zoom().on("zoom", handleZoom);
    svg.call(zoom);
    $(this.el).find(".select-colour-property").on("change", function() {
      var t;
      if (!(this.value != null)) {
        return;
      }
      currentColourProperty = this.value;
      getCellColour = defineColourScale(links, currentColourProperty);
      fillLeyendDetails();
      t = svg.transition().duration(1000);
      return t.selectAll(".vis-cell").style("fill", fillColour).attr('data-tooltip', getCellTooltip);
    });
    paintSortDirectionProxy = $.proxy(this.paintSortDirection, this);
    thisView = this;
    triggerRowSortTransition = function() {
      var rowTexts, t;
      t = svg.transition().duration(2500);
      t.selectAll('.vis-row').attr('transform', function(d) {
        return "translate(" + zoom.translate()[0] + ", " + (getYCoord(d.currentPosition) + zoom.translate()[1]) + ")";
      });
      rowTexts = svg.selectAll('.vis-row').selectAll('text').attr('data-tooltip', getRowTooltip);
      return $(rowTexts).tooltip();
    };
    handleSortDirClick = function() {
      var targetDimension;
      targetDimension = $(this).attr('data-target-property');
      if (targetDimension === 'row') {
        console.log('re-sort rows');
        currentRowSortingPropertyReverse = !currentRowSortingPropertyReverse;
        sortMatrixRowsBy(currentRowSortingProperty, currentRowSortingPropertyReverse);
        paintSortDirectionProxy('.btn-row-sort-direction-container', currentRowSortingPropertyReverse, 'row');
        triggerRowSortTransition();
      } else if (targetDimension === 'col') {
        currentColSortingPropertyReverse = !currentColSortingPropertyReverse;
        sortMatrixColsBy(currentColSortingProperty, currentColSortingPropertyReverse);
        paintSortDirectionProxy('.btn-col-sort-direction-container', currentColSortingPropertyReverse, 'col');
        triggerColSortTransition();
      }
      return $(thisView.el).find('.btn-sort-direction').on('click', handleSortDirClick);
    };
    $(this.el).find('.btn-sort-direction').on('click', handleSortDirClick);
    $(this.el).find(".select-row-sort").on("change", function() {
      if (!(this.value != null)) {
        return;
      }
      currentRowSortingProperty = this.value + '_sum';
      sortMatrixRowsBy(currentRowSortingProperty, currentRowSortingPropertyReverse);
      paintSortDirectionProxy('.btn-col-sort-direction-container', currentColSortingPropertyReverse, 'col');
      return triggerRowSortTransition();
    });
    triggerColSortTransition = function() {
      var columnTexts, t;
      t = svg.transition().duration(2500);
      t.selectAll(".vis-column").attr("transform", function(d) {
        return "translate(" + getXCoord(d.currentPosition) + ")rotate(-90)";
      });
      t.selectAll(".vis-cell").attr("x", function(d, index) {
        return getXCoord(matrix.columns[index % matrix.columns.length].currentPosition);
      });
      columnTexts = svg.selectAll(".vis-column").selectAll('text').attr('data-tooltip', getColumnTooltip);
      return $(columnTexts).tooltip();
    };
    $(this.el).find(".select-col-sort").on("change", function() {
      if (!(this.value != null)) {
        return;
      }
      currentColSortingProperty = this.value + '_sum';
      sortMatrixColsBy(currentColSortingProperty, currentColSortingPropertyReverse);
      return triggerColSortTransition();
    });
    resetZoom = function() {
      zoom.scale(1);
      zoom.translate([0, 0]);
      return handleZoom();
    };
    return $(this.el).find(".reset-zoom-btn").click(function() {
      return resetZoom();
    });
  }
});
