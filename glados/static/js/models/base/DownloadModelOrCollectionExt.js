// Generated by CoffeeScript 1.4.0
var DownloadModelOrCollectionExt;

DownloadModelOrCollectionExt = {
  getBlobToDownload: function(contentStr, contentType) {
    if (contentType == null) {
      contentType = 'text/plain;charset=utf-8';
    }
    return new Blob([contentStr], {
      type: contentType
    });
  },
  getDownloadObject: function(downloadParserFunction) {
    var content, m;
    content = this.attributes != null ? this.attributes : (function() {
      var _i, _len, _ref, _results;
      _ref = this.models;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        m = _ref[_i];
        _results.push(m.attributes);
      }
      return _results;
    }).call(this);
    if (!(downloadParserFunction != null)) {
      if (content instanceof Array) {
        return content;
      } else {
        return [content];
      }
    } else {
      return downloadParserFunction(content);
    }
  },
  getCSVHeaderString: function(downloadObject) {
    var key, keys, value, _ref;
    keys = [];
    _ref = downloadObject[0];
    for (key in _ref) {
      value = _ref[key];
      keys.push(key);
    }
    return keys.join(';');
  },
  getCSVContentString: function(downloadObject) {
    var key, obj, rows, value, values, _i, _len;
    rows = [];
    for (_i = 0, _len = downloadObject.length; _i < _len; _i++) {
      obj = downloadObject[_i];
      values = [];
      for (key in obj) {
        value = obj[key];
        values.push(JSON.stringify(obj[key]));
      }
      rows.push(values.join(';'));
    }
    return rows.join('\n');
  },
  getFullCSVString: function(downloadObject) {
    var content, header;
    header = this.getCSVHeaderString(downloadObject);
    content = this.getCSVContentString(downloadObject);
    return header + '\n' + content;
  },
  downloadCSV: function(filename, downloadParserFunction) {
    var blob, downloadObject, strContent;
    downloadObject = this.getDownloadObject(downloadParserFunction);
    strContent = this.getFullCSVString(downloadObject);
    blob = this.getBlobToDownload(strContent);
    saveAs(blob, filename);
    return strContent;
  },
  getJSONString: function(downloadObject) {
    return JSON.stringify(downloadObject);
  },
  downloadJSON: function(filename, downloadParserFunction) {
    var blob, downloadObject, strContent;
    downloadObject = this.getDownloadObject(downloadParserFunction);
    strContent = this.getJSONString(downloadObject);
    blob = this.getBlobToDownload(strContent);
    saveAs(blob, filename);
    return strContent;
  },
  getXLSString: function(downloadObject) {
    var Workbook, cellContent, cellNumber, cellVal, currentColumn, currentRow, key, obj, range, rows, s2ab, value, wb, wbout, ws, _i, _len, _ref;
    Workbook = function() {
      if (!(this instanceof Workbook)) {
        return new Workbook;
      }
      this.SheetNames = [];
      this.Sheets = {};
    };
    wb = new Workbook();
    wb.SheetNames.push('sheet1');
    ws = {};
    currentRow = 0;
    currentColumn = 0;
    _ref = downloadObject[0];
    for (key in _ref) {
      value = _ref[key];
      cellNumber = XLSX.utils.encode_cell({
        c: currentColumn,
        r: currentRow
      });
      cellContent = {
        v: key,
        t: 's'
      };
      ws[cellNumber] = cellContent;
      currentColumn++;
    }
    rows = [];
    for (_i = 0, _len = downloadObject.length; _i < _len; _i++) {
      obj = downloadObject[_i];
      currentRow++;
      currentColumn = 0;
      for (key in obj) {
        value = obj[key];
        cellNumber = XLSX.utils.encode_cell({
          c: currentColumn,
          r: currentRow
        });
        if (value != null) {
          cellVal = value;
        } else {
          cellVal = '---';
        }
        cellContent = {
          v: String(cellVal),
          t: 's'
        };
        ws[cellNumber] = cellContent;
        currentColumn++;
      }
    }
    range = {
      s: {
        c: 0,
        r: 0
      },
      e: {
        c: currentColumn - 1,
        r: currentRow
      }
    };
    ws['!ref'] = XLSX.utils.encode_range(range);
    wb.Sheets['sheet1'] = ws;
    wbout = XLSX.write(wb, {
      bookType: 'xlsx',
      bookSST: true,
      type: 'binary'
    });
    s2ab = function(s) {
      var buf, i, view;
      buf = new ArrayBuffer(s.length);
      view = new Uint8Array(buf);
      i = 0;
      while (i !== s.length) {
        view[i] = s.charCodeAt(i) & 0xFF;
        ++i;
      }
      return buf;
    };
    return s2ab(wbout);
  },
  downloadXLS: function(filename, downloadParserFunction) {
    var ab2s, blob, downloadObject, strContent;
    downloadObject = this.getDownloadObject(downloadParserFunction);
    strContent = this.getXLSString(downloadObject);
    blob = this.getBlobToDownload(strContent, 'application/octet-stream');
    saveAs(blob, filename);
    ab2s = function(buf) {
      return String.fromCharCode.apply(null, new Uint8Array(buf));
    };
    return ab2s(strContent);
  }
};
