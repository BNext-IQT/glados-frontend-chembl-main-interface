// Generated by CoffeeScript 1.4.0
var DocumentAssayNetwork;

DocumentAssayNetwork = Backbone.Model.extend(DownloadModelExt).extend({
  fetch: function() {
    var activitiesListsReceived, activitiesListsRequested, allAssays, assaysUrl, checkIfAllInfoReady, docChemblId, links, nodes, thisModel, triggerActivityRequest, triggerAssayRequest;
    docChemblId = this.get('document_chembl_id');
    assaysUrl = Settings.WS_BASE_URL + 'assay.json?document_chembl_id=' + docChemblId + '&limit=1000';
    allAssays = {};
    activitiesListsRequested = 0;
    activitiesListsReceived = 0;
    triggerAssayRequest = function(currentUrl) {
      var getAssaysGroup;
      getAssaysGroup = $.getJSON(currentUrl, function(response) {
        var newAssays, nextUrl;
        newAssays = response.assays;
        $.each(newAssays, function(index, newAssay) {
          var currentActsUrl;
          allAssays[newAssay.assay_chembl_id] = newAssay;
          currentActsUrl = Settings.WS_BASE_URL + 'activity.json?assay_chembl_id=' + newAssay.assay_chembl_id + '&limit=1000';
          activitiesListsRequested++;
          console.log('num activities lists requested: ', activitiesListsRequested);
          return triggerActivityRequest(currentActsUrl);
        });
        nextUrl = response.page_meta.next;
        if (nextUrl != null) {
          return triggerAssayRequest(Settings.WS_HOSTNAME + nextUrl);
        } else {
          console.log('ALL ASSAYS OBTAINED');
          console.log(allAssays);
          return console.log(_.pluck(allAssays, 'assay_chembl_id'));
        }
      });
      return getAssaysGroup.fail(function() {
        return console.log('FAILED getting assays list!');
      });
    };
    triggerAssayRequest(assaysUrl);
    triggerActivityRequest = function(currentActsUrl) {
      var getActivityGroup;
      console.log('requesting activities: ', currentActsUrl);
      getActivityGroup = $.getJSON(currentActsUrl, function(response) {
        var newActivities, nextUrl;
        newActivities = response.activities;
        $.each(newActivities, function(index, newActivity) {
          var currentAssay;
          console.log('new activity from assay: ', newActivity.assay_chembl_id, ' to molecule: ', newActivity.molecule_chembl_id);
          currentAssay = allAssays[newActivity.assay_chembl_id];
          if (currentAssay.compound_act_list == null) {
            currentAssay.compound_act_list = {};
          }
          return currentAssay.compound_act_list[newActivity.molecule_chembl_id] = 1;
        });
        nextUrl = response.page_meta.next;
        if (nextUrl != null) {
          triggerActivityRequest(Settings.WS_HOSTNAME + nextUrl);
          return console.log('requesting more activities');
        } else {
          activitiesListsReceived++;
          console.log('num lists received: ', activitiesListsReceived);
          return checkIfAllInfoReady();
        }
      });
      return getActivityGroup.fail(function() {
        return console.log('FAILED activities list!');
      });
    };
    nodes = [];
    links = [];
    thisModel = this;
    return checkIfAllInfoReady = function() {
      var answer;
      if (activitiesListsRequested === activitiesListsReceived) {
        $.each(allAssays, function(index, assay) {
          assay.name = assay.assay_chembl_id;
          return nodes.push(assay);
        });
        console.log('ALL READY!');
        console.log(nodes);
        $.each(nodes, function(i, assayI) {
          var compoundsI;
          console.log('I: ', i);
          console.log('I is: ', assayI.assay_chembl_id);
          compoundsI = assayI.compound_act_list;
          return $.each(nodes, function(j, assayJ) {
            var compoundsJ, molecule_chembl_id, numEqual, val;
            if (i > j) {
              return;
            }
            console.log('J: ', j);
            console.log('J is: ', assayJ.assay_chembl_id);
            compoundsJ = assayJ.compound_act_list;
            console.log('comparing ', assayI.assay_chembl_id, ' with ', assayJ.assay_chembl_id);
            console.log('lists: ', compoundsI, ' , ', compoundsJ);
            numEqual = 0;
            for (molecule_chembl_id in compoundsI) {
              val = compoundsI[molecule_chembl_id];
              if (compoundsJ[molecule_chembl_id] === 1) {
                numEqual++;
              }
            }
            links.push({
              "source": i,
              "target": j,
              "value": numEqual
            });
            console.log(numEqual, ' are equal!');
            return console.log('^^^^');
          });
        });
        console.log('nodes: ', nodes);
        console.log('links ', links);
        console.log('contxt: ', this);
        answer = {
          'nodes': nodes,
          'links': links
        };
        return thisModel.set('graph', answer);
      }
    };
  }
});
